# 重複投稿の原因分析（ログベース）

## ログから確認できた事実

### 1. 2つのワーカープロセスが同時に起動
```
[2025-11-04 02:31:24 +0000] [1026] [INFO] Booting worker with pid: 1026
[2025-11-04 02:31:24 +0000] [1027] [INFO] Booting worker with pid: 1027
```

### 2. 同じファイルが2つのワーカーで同時に処理される
```
2025-11-04T02:37:34.862237061Z  [Drive] Processing new file: テスト23.txt (1fBfq4BUsqbUsovUVWy6Lqt26OT3twbq2)
2025-11-04T02:37:35.235418557Z  [Drive] Processing new file: テスト23.txt (1fBfq4BUsqbUsovUVWy6Lqt26OT3twbq2)
```

### 3. 重複チェックのログメッセージが出力されていない
- `[Slack] Draft {draft_id} already posted, skipping duplicate` というメッセージが**ログに存在しない**
- これは、重複チェックが機能していないことを意味する

## 原因の特定

### 根本原因：複数ワーカープロセスのメモリ分離

**問題の流れ：**
1. ワーカー1（PID 1026）が `テスト23.txt` を検出
2. ワーカー2（PID 1027）もほぼ同時に `テスト23.txt` を検出
3. ワーカー1が `process_text_pipeline` を実行 → `post_slack_draft` を呼び出し
4. ワーカー2も `process_text_pipeline` を実行 → `post_slack_draft` を呼び出し
5. **両方のワーカーが独立した `DRAFT_META` を持っているため、両方とも「未投稿」と判断**
6. 両方のワーカーがSlackに投稿 → **重複投稿が発生**

### Phase 3の変更による影響

**元の実装（main_original_backup.py）:**
- `post_slack_draft` 関数がグローバル変数 `DRAFT_META` を直接参照
- しかし、各ワーカープロセスは独立したメモリ空間を持つため、**元のコードでも同じ問題が発生していた可能性が高い**

**Phase 3後の実装:**
- `post_slack_draft` 関数が `draft_meta` をパラメータとして受け取る
- Pythonでは辞書は参照渡しなので、理論的には同じオブジェクトを参照するはず
- しかし、**各ワーカープロセスが独立した `DRAFT_META` を持っているため、参照渡しでも解決しない**

## 結論

**Phase 3の変更自体が直接的な原因ではない**が、問題が顕在化した可能性がある。

**実際の問題：**
- Azure App Serviceで `--workers 2` により2つのワーカープロセスが実行されている
- 各ワーカーは独立したメモリ空間を持つ
- メモリ上の `DRAFT_META` はワーカー間で共有されない
- そのため、重複チェックが機能しない

## 解決策

### 推奨解決策：ファイルベースの重複チェック

メモリ上の `DRAFT_META` ではなく、ファイルシステムに投稿済みフラグを保存することで、複数のワーカープロセス間で重複チェックを共有できる。

**実装方法：**
1. `SUMM_DIR` に `{draft_id}.json` が存在することを確認（既に実装済み）
2. 追加で、`SUMM_DIR` に `{draft_id}.posted` のようなフラグファイルを作成
3. `post_slack_draft` で、フラグファイルの存在を確認してから投稿
4. 投稿成功後、フラグファイルを作成

この方法により、複数のワーカープロセス間で重複チェックが機能する。

